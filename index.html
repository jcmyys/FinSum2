<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Ï£ºÏãù Îç∞Ïù¥ÌÑ∞ ÌÜµÌï© Î∑∞ (Light Ver)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
    }
    
    .nav-bar { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .nav-link { 
      text-decoration: none; color: #555; padding: 8px 12px; 
      border: 1px solid #ddd; border-radius: 5px; background: #fff; 
      display: flex; align-items: center; gap: 6px; font-size: 14px;
      transition: all 0.2s;
    }
    .nav-link:hover { background: #f0f0f0; color: #007bff; border-color: #007bff; }
    .nav-link.active { background: #007bff; color: white; border-color: #007bff; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      text-align: center;
      margin-bottom: 40px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      word-wrap: break-word;
    }
    th {
      background-color: #f4f4f4;
    }
    .highest { color: red; font-weight: bold; }
    .rise-row { background-color: #fff0f0; font-weight: bold; color: #d32f2f; }
    .fall-row { background-color: #f0f8ff; font-weight: bold; color: #0056b3; }
    .price-val-row { background-color: #fcfcfc; color: #555; font-size: 0.95em; }
    .divider-row td { border-bottom: 2px solid #999; }
    
    input[type="number"] { width: 80%; text-align: right; }
    
    .ticker-input {
      width: 80%;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      border: none;
      background: transparent;
      color: inherit;
      padding: 4px;
      border-bottom: 1px dashed #999;
      cursor: text;
    }
    .ticker-input:focus { outline: none; background-color: #fff; border-bottom: 2px solid blue; }
    .price-label { margin-left: 5px; color: blue; font-weight: bold; font-size: 0.8em; display: block; }

    .btn {
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      transition: all 0.2s;
      margin-right: 5px;
    }
    .btn:hover { background-color: #eee; }
    .btn-primary { background-color: #007bff; color: white; border: none; }
    .btn-primary:hover { background-color: #0056b3; }
    .btn-danger { background-color: #fff; color: #dc3545; border: 1px solid #dc3545; }
    .btn-danger:hover { background-color: #dc3545; color: white; }
    #transaction-button { background-color: #ffcccc; border: 1px solid #ff9999; }
    #transaction-button:hover { background-color: #ff9999; }

    .pagination-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .page-controls { display: flex; align-items: center; gap: 5px; }
    .page-btn {
      width: 35px; height: 35px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; color: #555;
    }
    .page-btn.active { background-color: #007bff; color: white; border-color: #007bff; }
    .page-btn:hover:not(.active) { background-color: #e9ecef; }
    .page-action-btn { font-size: 14px; padding: 0 12px; height: 35px; }

    .ratio-box {
      margin-top: 20px;
      font-size: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      width: 420px;
      line-height: 1.6;
    }
    
    .loading-overlay { opacity: 0.5; pointer-events: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div class="nav-bar">
    <a href="index.html" class="nav-link active"><i class="fas fa-home"></i> ÌÜµÌï© Î∑∞</a>
    <a href="rebalancing.html" class="nav-link"><i class="fas fa-balance-scale"></i> Î¶¨Î∞∏Îü∞Ïã±</a>
    <a href="trend.html" class="nav-link"><i class="fas fa-chart-line"></i> US ÏàòÏùµÎ•†</a>
    <a href="k-trend.html" class="nav-link"><i class="fas fa-won-sign"></i> KR ÏàòÏùµÎ•†</a>
    <a href="top_chart.html" class="nav-link"><i class="fas fa-trophy"></i> ÏãúÏ¥ù Top</a>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3>üìà Ï£ºÏãù Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞ Î∞è Î≥ÄÍ≥°Ï†ê Î∂ÑÏÑù</h3>
    <div>
      <button id="load-button" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞</button>
      <button id="transaction-button" class="btn"><i class="fas fa-file-invoice-dollar"></i> Îß§Îß§Í∏∞Î°ù</button>
    </div>
  </div>
  
  <div style="margin-top:5px; font-size:14px; color:#666; margin-bottom: 15px;">
    * ÌëúÏùò Ï¢ÖÎ™©Î™Ö(Ïòà: GOOGL)ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Î≥ÄÍ≤Ω Í∞ÄÎä•. Îπà Ïπ∏Ïóê Ï¢ÖÎ™©ÏùÑ ÏûÖÎ†•ÌïòÎ©¥ Ï∂îÍ∞ÄÎê©ÎãàÎã§.
  </div>

  <div class="pagination-container">
    <div class="page-controls" id="pagination-numbers"></div>
    <div class="page-controls">
      <button class="btn page-action-btn" onclick="addNewPage()" title="ÏÉà ÌéòÏù¥ÏßÄ Ï∂îÍ∞Ä">
        <i class="fas fa-plus"></i> ÌéòÏù¥ÏßÄ Ï∂îÍ∞Ä
      </button>
      <button class="btn page-action-btn btn-danger" onclick="deleteCurrentPage()" title="ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÏÇ≠Ï†ú">
        <i class="fas fa-trash-alt"></i> ÌéòÏù¥ÏßÄ ÏÇ≠Ï†ú
      </button>
    </div>
  </div>

  <div id="table-container">
    <table id="stock-table">
      <thead>
        <tr>
          <th style="width: 120px;">ÎÇ†Ïßú/Íµ¨Î∂Ñ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Í∏∞Ï§ÄÍ∞ÄÍ≤© Î∞è Í∞ÄÍ≤© Î†àÎ≤® ÎπÑÍµêÌëú</h3>
    <table id="price-table">
      <thead>
        <tr id="symbols-row"></tr>
        <tr id="base-price-row"></tr>
      </thead>
      <tbody id="price-level-rows"></tbody>
    </table>
  </div>

  <h3>üá∫üá∏ ÎØ∏Íµ≠ ÏãúÍ∞ÄÏ¥ùÏï° 1~4ÏúÑ Ïã§ÏãúÍ∞Ñ Î≥ÄÌôî</h3>
  <div id="desc" style="font-size: 14px; color: #666; margin-bottom: 5px;">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
  <canvas id="marketCapChart" width="720" height="340"></canvas>
  <div class="ratio-box" id="ratios"></div>

  <script>
    const INFLECTION_THRESHOLD = 0.02; 
    const DAYS_TO_SHOW = 25; 
    const decrementRate = 0.05;
    const decrementRows = 15;
    const ITEMS_PER_PAGE = 9; 
    
    const STORAGE_KEY_PRICES = 'stockBasePrices';
    const STORAGE_KEY_SYMBOLS = 'stockSymbols_v3';
    const STORAGE_KEY_CUR_PAGE = 'stockCurrentPage';

    // ÌîÑÎ°ùÏãú ÏÑúÎ≤Ñ IP ÏÑ§Ï†ï (Î≥∏Ïù∏ ÏÑúÎ≤Ñ IP)
    const PROXY_SERVER = "http://134.185.108.103:3000/proxy?url=";

    const defaultSymbols = ['GOOGL', 'SPYM', 'AAPL', 'NVDA', 'AMD', 'UEC', 'AMZN', 'TSLA', 'MSFT'];
    
    let symbols = [];
    let basePrices = {};
    let allStockData = {}; 
    let latest52Highs = {}; 
    let latest52Lows = {};  
    let latestClosePrices = {};
    let currentPage = 1;

    function loadSettings() {
      const storedSymbols = localStorage.getItem(STORAGE_KEY_SYMBOLS);
      if (storedSymbols) {
        try { symbols = JSON.parse(storedSymbols); } catch (e) { symbols = [...defaultSymbols]; }
      } else {
        symbols = [...defaultSymbols];
      }

      const remainder = symbols.length % ITEMS_PER_PAGE;
      if (remainder !== 0) {
        const fillCount = ITEMS_PER_PAGE - remainder;
        for(let i=0; i<fillCount; i++) symbols.push("");
      }

      const storedPage = localStorage.getItem(STORAGE_KEY_CUR_PAGE);
      if (storedPage) currentPage = parseInt(storedPage);
      const maxPage = Math.max(1, Math.ceil(symbols.length / ITEMS_PER_PAGE));
      if (currentPage > maxPage) currentPage = maxPage;
      if (currentPage < 1) currentPage = 1;

      defaultSymbols.forEach(s => basePrices[s] = 0);
      const initialDefaults = {
        'AAPL': 256.87, 'SPYM': 78.68, 'MSFT': 514.45,
        'GOOGL': 125.30, 'AMD': 161.27, 'UEC': 13.50, 'NVDA': 135.00
      };
      Object.assign(basePrices, initialDefaults);

      const storedPrices = localStorage.getItem(STORAGE_KEY_PRICES);
      if (storedPrices) {
        try {
          const parsed = JSON.parse(storedPrices);
          Object.assign(basePrices, parsed);
        } catch (e) {}
      }
    }

    function saveSymbols() { localStorage.setItem(STORAGE_KEY_SYMBOLS, JSON.stringify(symbols)); }
    function saveBasePrices() { localStorage.setItem(STORAGE_KEY_PRICES, JSON.stringify(basePrices)); }
    function saveCurrentPage() { localStorage.setItem(STORAGE_KEY_CUR_PAGE, currentPage); }

    function getTotalPages() { return Math.max(1, Math.ceil(symbols.length / ITEMS_PER_PAGE)); }

    function changePage(pageNum) {
      if (pageNum < 1 || pageNum > getTotalPages()) return;
      currentPage = pageNum;
      saveCurrentPage();
      renderAll();
    }

    function addNewPage() {
      for (let i = 0; i < ITEMS_PER_PAGE; i++) symbols.push("");
      saveSymbols();
      changePage(getTotalPages());
    }

    function deleteCurrentPage() {
      const total = getTotalPages();
      if (total <= 1) { alert("ÏµúÏÜå Ìïú ÌéòÏù¥ÏßÄÎäî Ï°¥Ïû¨Ìï¥Ïïº Ìï©ÎãàÎã§."); return; }
      if (!confirm(`${currentPage}ÌéòÏù¥ÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

      const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
      symbols.splice(startIndex, ITEMS_PER_PAGE);
      saveSymbols();

      if (currentPage > getTotalPages()) currentPage = getTotalPages();
      saveCurrentPage();
      renderAll();
    }

    function renderPagination() {
      const container = document.getElementById('pagination-numbers');
      container.innerHTML = '';
      const totalPages = getTotalPages();

      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-btn';
      prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevBtn.onclick = () => changePage(currentPage - 1);
      if (currentPage === 1) prevBtn.style.opacity = 0.5;
      container.appendChild(prevBtn);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        btn.textContent = i;
        btn.onclick = () => changePage(i);
        container.appendChild(btn);
      }

      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-btn';
      nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextBtn.onclick = () => changePage(currentPage + 1);
      if (currentPage === totalPages) nextBtn.style.opacity = 0.5;
      container.appendChild(nextBtn);
    }

    async function fetchSymbolData(symbol) {
      if (!symbol) return { history: null, high52: null, low52: null };
      const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=3mo`;
      const chartUrl = PROXY_SERVER + encodeURIComponent(yahooUrl);
      
      try {
        const chartRes = await fetch(chartUrl);
        if (!chartRes.ok) throw new Error("Chart network error");
        const chartData = await chartRes.json();

        if (!chartData.chart?.result?.[0]) throw new Error("No chart data");
        const result = chartData.chart.result[0];
        const timestamps = result.timestamp;
        const quotes = result.indicators.quote[0];
        
        const closePrices = {};
        if (timestamps && quotes.close) {
          timestamps.forEach((ts, index) => {
            if (quotes.close[index] !== null) {
              const date = new Date(ts * 1000).toISOString().split('T')[0];
              closePrices[date] = parseFloat(quotes.close[index]);
            }
          });
        }

        let high52 = result.meta?.fiftyTwoWeekHigh || null;
        let low52 = result.meta?.fiftyTwoWeekLow || null;

        return { history: closePrices, high52, low52 };
      } catch (e) {
        console.error(`Fetch failed for ${symbol}`, e);
        throw e;
      }
    }

    async function fetchAllStockData() {
      const validSymbols = symbols.filter(s => s !== "");
      const promises = validSymbols.map(async (sym) => {
        try {
          const { history, high52, low52 } = await fetchSymbolData(sym);
          if(history) allStockData[sym] = history;
          latest52Highs[sym] = high52;
          latest52Lows[sym] = low52;
        } catch (e) {
          allStockData[sym] = {}; 
        }
      });
      await Promise.all(promises);
    }

    async function handleTickerChange(globalIndex, newTicker) {
      newTicker = newTicker.toUpperCase().trim();
      if (newTicker === symbols[globalIndex]) return;
      if (newTicker !== "" && symbols.includes(newTicker)) {
        alert("Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ï¢ÖÎ™©ÏûÖÎãàÎã§.");
        renderAll(); 
        return;
      }

      if (newTicker === "") {
        symbols[globalIndex] = "";
        saveSymbols();
        renderAll();
        return;
      }

      try {
        const { history, high52, low52 } = await fetchSymbolData(newTicker);
        symbols[globalIndex] = newTicker;
        saveSymbols();
        allStockData[newTicker] = history;
        latest52Highs[newTicker] = high52;
        latest52Lows[newTicker] = low52;

        const dates = Object.keys(history).sort((a, b) => b.localeCompare(a));
        if (dates.length > 0) {
          basePrices[newTicker] = parseFloat(history[dates[0]].toFixed(2));
        }
        saveBasePrices();
        renderAll();
      } catch (e) {
        alert(`'${newTicker}' Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.`);
        renderAll();
      }
    }

    function getLatestInflectionPoint(pricesObj, threshold) {
      if (!pricesObj) return null;
      const dates = Object.keys(pricesObj).sort(); 
      if (dates.length < 2) return null;

      let startPrice = pricesObj[dates[0]];
      let currentTrend = null; 
      let startIndex = 0;
      
      for (let i = 1; i < dates.length; i++) {
        const p = pricesObj[dates[i]];
        const change = (p - startPrice) / startPrice;
        if (Math.abs(change) >= threshold) {
          currentTrend = change > 0 ? 'UP' : 'DOWN';
          startIndex = i;
          break;
        }
      }
      if (!currentTrend) return null;

      let lastPivot = { type: currentTrend === 'UP' ? 'LOW' : 'HIGH', price: startPrice, date: dates[0] };
      let tempExtremePrice = startPrice;
      let tempExtremeDate = dates[0];

      for (let i = 0; i < dates.length; i++) {
        const date = dates[i];
        const price = pricesObj[date];
        if (currentTrend === 'UP') {
          if (price > tempExtremePrice) { tempExtremePrice = price; tempExtremeDate = date; }
          else if (price < tempExtremePrice * (1 - threshold)) {
            lastPivot = { type: 'HIGH', price: tempExtremePrice, date: tempExtremeDate };
            currentTrend = 'DOWN';
            tempExtremePrice = price; tempExtremeDate = date;
          }
        } else { 
          if (price < tempExtremePrice) { tempExtremePrice = price; tempExtremeDate = date; }
          else if (price > tempExtremePrice * (1 + threshold)) {
            lastPivot = { type: 'LOW', price: tempExtremePrice, date: tempExtremeDate };
            currentTrend = 'UP';
            tempExtremePrice = price; tempExtremeDate = date;
          }
        }
      }
      return lastPivot;
    }

    function renderAll() {
      renderPagination();
      renderStockTable();
      renderBasePriceTableHeader();
      renderPriceLevelsTable();
    }

    function getCurrentPageSymbols() {
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      return symbols.slice(start, start + ITEMS_PER_PAGE).map((sym, i) => ({
        symbol: sym,
        globalIndex: start + i
      }));
    }

    function renderStockTable() {
      const pageSymbols = getCurrentPageSymbols();
      const theadRow = document.querySelector('#stock-table thead tr');
      theadRow.innerHTML = '<th>ÎÇ†Ïßú/Íµ¨Î∂Ñ</th>';

      pageSymbols.forEach((item) => {
        const th = document.createElement('th');
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'ticker-input';
        input.value = item.symbol;
        input.onchange = (e) => handleTickerChange(item.globalIndex, e.target.value);
        th.appendChild(input);
        theadRow.appendChild(th);
      });

      const tbody = document.querySelector('#stock-table tbody');
      tbody.innerHTML = '';
      
      const highestPrices = {};
      const lowestPrices = {};

      pageSymbols.forEach(item => {
        const sym = item.symbol;
        if (sym && allStockData[sym]) {
            const prices = Object.values(allStockData[sym]);
            highestPrices[sym] = Math.max(...prices);
            lowestPrices[sym] = Math.min(...prices);
            const dates = Object.keys(allStockData[sym]).sort((a, b) => b.localeCompare(a));
            latestClosePrices[sym] = allStockData[sym][dates[0]];
        }
      });

      const createRow = (className, label) => {
        const tr = document.createElement('tr');
        tr.className = className;
        tr.innerHTML = `<td>${label}</td>`;
        return tr;
      };

      const row52High = createRow('price-val-row', '52Ï£º ÏµúÍ≥†');
      const row52Low = createRow('price-val-row', '52Ï£º ÏµúÏ†Ä');
      const rowRisePct = createRow('rise-row', 'Ï†ÄÏ†ê ÎåÄÎπÑ ÏÉÅÏäπ');
      const rowLowVal = createRow('price-val-row', 'Ï†ÄÏ†êÍ∞í');
      const rowDropPct = createRow('fall-row', 'Í≥†Ï†ê ÎåÄÎπÑ ÌïòÎùΩ');
      const rowHighVal = createRow('price-val-row', 'Í≥†Ï†êÍ∞í');
      const rowReboundPct = createRow('rise-row', 'ÏÉÅÏäπÎ∞òÏ†Ñ');
      const rowReboundVal = createRow('price-val-row', 'ÏÉÅÏäπÏ†ÑÌôòÍ∞í');
      const rowPullbackPct = createRow('fall-row', 'ÌïòÎùΩÎ∞òÏ†Ñ');
      const rowPullbackVal = createRow('price-val-row divider-row', 'ÌïòÎùΩÏ†ÑÌôòÍ∞í');

      pageSymbols.forEach(item => {
        const sym = item.symbol;
        if (!sym) {
           [row52High, row52Low, rowRisePct, rowLowVal, rowDropPct, rowHighVal, rowReboundPct, rowReboundVal, rowPullbackPct, rowPullbackVal]
           .forEach(r => r.innerHTML += '<td></td>');
           return;
        }
        row52High.innerHTML += `<td>${latest52Highs[sym]?.toFixed(2) || '-'}</td>`;
        row52Low.innerHTML += `<td>${latest52Lows[sym]?.toFixed(2) || '-'}</td>`;

        const cur = latestClosePrices[sym], lo = lowestPrices[sym], hi = highestPrices[sym];
        rowRisePct.innerHTML += `<td>${(cur && lo) ? '+' + (((cur - lo) / lo) * 100).toFixed(2) + '%' : '-'}</td>`;
        rowLowVal.innerHTML += `<td>${lo?.toFixed(2) || '-'}</td>`;
        rowDropPct.innerHTML += `<td>${(cur && hi) ? (((cur - hi) / hi) * 100).toFixed(2) + '%' : '-'}</td>`;
        rowHighVal.innerHTML += `<td>${hi?.toFixed(2) || '-'}</td>`;

        const inf = getLatestInflectionPoint(allStockData[sym], INFLECTION_THRESHOLD);
        let rebP = '-', rebV = '-', pulP = '-', pulV = '-';
        if (inf && cur) {
          if (inf.type === 'LOW') { rebP = `+${((cur - inf.price)/inf.price*100).toFixed(2)}%`; rebV = inf.price.toFixed(2); }
          else { pulP = `${((cur - inf.price)/inf.price*100).toFixed(2)}%`; pulV = inf.price.toFixed(2); }
        }
        rowReboundPct.innerHTML += `<td>${rebP}</td>`;
        rowReboundVal.innerHTML += `<td>${rebV}</td>`;
        rowPullbackPct.innerHTML += `<td>${pulP}</td>`;
        rowPullbackVal.innerHTML += `<td>${pulV}</td>`;
      });

      tbody.append(row52High, row52Low, rowRisePct, rowLowVal, rowDropPct, rowHighVal, rowReboundPct, rowReboundVal, rowPullbackPct, rowPullbackVal);

      const allDates = [...new Set(Object.values(allStockData).flatMap(d => Object.keys(d)))].sort((a,b) => b.localeCompare(a)).slice(0, DAYS_TO_SHOW);
      allDates.forEach(date => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${date}</td>`;
        pageSymbols.forEach(item => {
          const p = allStockData[item.symbol]?.[date];
          tr.innerHTML += p ? `<td class="${p === highestPrices[item.symbol] ? 'highest' : ''}">${p.toFixed(2)}</td>` : '<td>-</td>';
        });
        tbody.appendChild(tr);
      });
    }

    function renderBasePriceTableHeader() {
      const pageSymbols = getCurrentPageSymbols();
      const symbolsRow = document.getElementById('symbols-row');
      const basePriceRow = document.getElementById('base-price-row');
      symbolsRow.innerHTML = '<th></th>';
      basePriceRow.innerHTML = '<td>Í∏∞Ï§ÄÍ∞ÄÍ≤©</td>';

      pageSymbols.forEach(item => {
        const sym = item.symbol;
        symbolsRow.innerHTML += `<th>${sym || "(ÎπÑÏñ¥ÏûàÏùå)"}</th>`;
        const td = document.createElement('td');
        if (sym) {
            const input = document.createElement('input');
            input.type = 'number'; input.step = '0.01'; input.value = parseFloat(basePrices[sym] || 0).toFixed(2);
            input.onchange = () => { basePrices[sym] = parseFloat(input.value); saveBasePrices(); renderPriceLevelsTable(); };
            td.appendChild(input);
        }
        basePriceRow.appendChild(td);
      });
    }

    function renderPriceLevelsTable() {
      const pageSymbols = getCurrentPageSymbols();
      const tbody = document.getElementById('price-level-rows');
      tbody.innerHTML = '';
      for (let i = 0; i < decrementRows; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${(100 - decrementRate * i * 100).toFixed(2)}% Í∏∞Ï§ÄÍ∞Ä</td>`;
        pageSymbols.forEach(item => {
          const sym = item.symbol;
          if (sym) {
              const lv = (basePrices[sym] || 0) * (1 - decrementRate * i);
              const cur = latestClosePrices[sym];
              tr.innerHTML += `<td>${lv.toFixed(2)}${ (cur && cur < lv) ? `<span class="price-label">${cur.toFixed(2)}</span>` : ''}</td>`;
          } else tr.innerHTML += '<td></td>';
        });
        tbody.appendChild(tr);
      }
    }

    async function onLoadButtonClick() {
      const btn = document.getElementById('load-button');
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Î°úÎî© Ï§ë...';
      document.getElementById('table-container').classList.add('loading-overlay');
      
      await fetchAllStockData();
      
      symbols.forEach(sym => {
        if (sym && allStockData[sym]) {
            const dates = Object.keys(allStockData[sym]).sort((a,b)=>b.localeCompare(a));
            const latest = allStockData[sym][dates[0]];
            if (latest && (basePrices[sym] === 0 || latest > basePrices[sym])) basePrices[sym] = parseFloat(latest.toFixed(2));
        }
      });
      saveBasePrices();
      renderAll();
      
      btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞';
      document.getElementById('table-container').classList.remove('loading-overlay');
    }

    function goToTransactionPage() {
      if (Object.keys(latestClosePrices).length === 0) { alert("Îç∞Ïù¥ÌÑ∞Î•º Î®ºÏ†Ä Î∂àÎü¨Ïò§ÏÑ∏Ïöî."); return; }
      localStorage.setItem('latestPrices', JSON.stringify(latestClosePrices));
      window.location.href = 'https://jcmyys.infinityfree.me/AssetDonut2/transaction.php';
    }

    // --- ÏãúÍ∞ÄÏ¥ùÏï° Ïã§ÏãúÍ∞Ñ Î≥ÄÌôî Î∞è Î™®Îì† Ï°∞Ìï© ÎπÑÏú® Í≥ÑÏÇ∞ Î£®Ìã¥ ---
    const symbols2 = ['NVDA', 'MSFT', 'AAPL', 'GOOGL'];
    const names = ['NVIDIA', 'Microsoft', 'Apple', 'Alphabet'];
    const shares = { 'NVDA': 24300000000, 'MSFT': 7430000000, 'AAPL': 14860000000, 'GOOGL': 12038760000 };
    const dtEnd = Math.floor(Date.now()/1000);
    const dtStart = dtEnd - (60*60*24*45);

    async function fetchHistory(symbol) {
      const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${dtStart}&period2=${dtEnd}&interval=1d`;
      const url = PROXY_SERVER + encodeURIComponent(yahooUrl);
      try {
        const r = await fetch(url);
        const j = await r.json();
        if(!j.chart?.result?.[0]) return null;
        const res = j.chart.result[0];
        const timestamps = res.timestamp || [];
        const closes = res.indicators.adjclose?.[0].adjclose || res.indicators.quote[0].close || [];
        return timestamps.map((ts, i) => ({
          date: new Date(ts * 1000).toISOString().slice(0,10),
          cap: closes[i] ? +(closes[i] * shares[symbol] / 1e12).toFixed(2) : null
        })).filter(item => item.cap !== null);
      } catch(e) { return null; }
    }

    async function main() {
      const results = await Promise.all(symbols2.map(fetchHistory));
      const validResults = results.filter(r => r && r.length > 0);
      if(validResults.length === 0) {
        document.getElementById('desc').innerHTML = "‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.";
        return;
      }
      const allDates = [...new Set(validResults.flat().map(d => d.date))].sort();
      const datasets = symbols2.map((sym, i) => {
        const dataMap = Object.fromEntries((results[i] || []).map(d => [d.date, d.cap]));
        return {
          label: names[i],
          data: allDates.map(date => dataMap[date] || null),
          borderColor: ['#3cb44b', '#0082c8', '#f58231', '#911eb4'][i],
          fill: false, tension: 0.25, spanGaps: true
        };
      });

      new Chart(document.getElementById('marketCapChart'), {
        type: 'line',
        data: { labels: allDates, datasets },
        options: {
          responsive: false, interaction: { mode: 'index', intersect: false },
          scales: { y: { title: { display: true, text: 'ÏãúÏ¥ù (Trillion USD)' } } }
        }
      });

      // ÏãúÏ¥ù ÏàúÏúÑÎ≥Ñ Ï†ïÎ†¨
      const latestInfo = symbols2.map((sym, i) => ({
        name: names[i], cap: (results[i] && results[i].length > 0) ? results[i][results[i].length - 1].cap : 0
      })).sort((a, b) => b.cap - a.cap);

      document.getElementById('desc').innerHTML = `${allDates[0]} ~ ${allDates[allDates.length-1]} Îç∞Ïù¥ÌÑ∞`;
      
      // Î™®Îì† Ï°∞Ìï©Ïóê ÎåÄÌïú ÎπÑÏú® Í≥ÑÏÇ∞ Î£®Ìã¥ (1vs2, 1vs3, 1vs4, 2vs3, 2vs4, 3vs4)
      let ratioHtml = "<strong>Ïã§ÏãúÍ∞Ñ ÏãúÏ¥ù ÏàúÏúÑ Î∞è ÏÉÅÏÑ∏ ÎπÑÏú®</strong><br>";
      latestInfo.forEach((item, idx) => {
          ratioHtml += `${idx + 1}Îì±: ${item.name} (${item.cap}T)${(idx % 2 === 0) ? ' / ' : '<br>'}`;
      });
      
      ratioHtml += "<hr style='border:0; border-top:1px solid #ddd; margin:10px 0;'><strong>Ï¢ÖÎ™© Í∞Ñ ÏÉÅÎåÄ ÏãúÏ¥ù ÎπÑÏú®</strong><br><div style='display:grid; grid-template-columns: 1fr 1fr; gap:5px;'>";
      
      for (let i = 0; i < latestInfo.length; i++) {
          for (let j = i + 1; j < latestInfo.length; j++) {
              const val1 = latestInfo[i].cap;
              const val2 = latestInfo[j].cap;
              const ratio = val2 > 0 ? (val1 / val2).toFixed(2) : "N/A";
              ratioHtml += `<span>${latestInfo[i].name}/${latestInfo[j].name}: <b>${ratio}</b></span>`;
          }
      }
      ratioHtml += "</div>";

      document.getElementById('ratios').innerHTML = ratioHtml;
    }

    document.getElementById('load-button').onclick = onLoadButtonClick;
    document.getElementById('transaction-button').onclick = goToTransactionPage;
    loadSettings();
    renderAll();
    main();
  </script>
</body>
</html>