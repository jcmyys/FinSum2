<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î¶¨Î∞∏Îü∞Ïã± Ï∞®Ìä∏ (Rebalancing)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 1200px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; }
        
        /* ÏÉÅÎã® ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä */
        .nav-bar { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .nav-link { 
            text-decoration: none; color: #555; padding: 8px 12px; 
            border: 1px solid #ddd; border-radius: 5px; background: #fff; 
            display: flex; align-items: center; gap: 6px; font-size: 14px;
            transition: all 0.2s;
        }
        .nav-link:hover { background: #f0f0f0; color: #007bff; border-color: #007bff; }
        .nav-link.active { background: #007bff; color: white; border-color: #007bff; }

        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        
        .input-group { display: flex; align-items: center; gap: 6px; }
        .input-group label { font-size: 14px; font-weight: bold; color: #555; }
        
        input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; }
        input:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        
        .symbol-input { width: 120px; text-transform: uppercase; }
        .number-input { width: 80px; }

        button.add-btn { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.15s; }
        button.add-btn:hover { background: #0056b3; }

        .symbol-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .tag { 
            padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 14px; 
            font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1px solid #dee2e6;
            background: #e9ecef; color: #495057;
        }
        .tag.active { background: #e7f1ff; color: #0d6efd; border-color: #0d6efd; font-weight: bold; }
        .tag:hover { transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tag span.remove { cursor: pointer; color: #dc3545; font-weight: bold; padding: 0 4px; z-index: 2; margin-left: 4px; }
        .tag span.remove:hover { color: #a71d2a; }

        .chart-container { position: relative; height: 65vh; width: 100%; }
        #statusMessage { text-align: center; margin-bottom: 10px; font-size: 14px; height: 20px; }

        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f1f3f5; padding-bottom: 10px; }
        
        .nav-btn { 
            padding: 8px 16px; color: white; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 14px; text-decoration: none; transition: background 0.2s;
        }
        
        /* Ïª§Ïä§ÌÖÄ Ìà¥ÌåÅ Ïä§ÌÉÄÏùº */
        #chartjs-tooltip {
            opacity: 0;
            position: absolute;
            pointer-events: none;
            transition: all .1s ease;
            font-size: 14px;
            font-weight: bold;
            color: white;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            z-index: 100;
            text-align: center;
            white-space: nowrap; 
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="nav-bar">
            <a href="index.html" class="nav-link"><i class="fas fa-home"></i> ÌÜµÌï© Î∑∞</a>
            <a href="rebalancing.html" class="nav-link active"><i class="fas fa-balance-scale"></i> Î¶¨Î∞∏Îü∞Ïã±</a>
            <a href="trend.html" class="nav-link"><i class="fas fa-chart-line"></i> US ÏàòÏùµÎ•†</a>
            <a href="k-trend.html" class="nav-link"><i class="fas fa-won-sign"></i> KR ÏàòÏùµÎ•†</a>
            <a href="top_chart.html" class="nav-link"><i class="fas fa-trophy"></i> ÏãúÏ¥ù Top</a>
        </div>

        <div class="nav-header">
            <h2 style="margin:0;">‚öñÔ∏è Î¶¨Î∞∏Îü∞Ïã± Ï∞®Ìä∏</h2>
            </div>
        
        <div class="controls">
            <div class="input-group">
                <input type="text" id="symbolInput" class="symbol-input" placeholder="Ï¢ÖÎ™© (Ïòà: TQQQ)" onkeypress="handleEnter(event)">
                <button class="add-btn" onclick="addSymbol()">Ï∂îÍ∞Ä</button>
            </div>
            <div style="width: 1px; height: 24px; background: #ddd; margin: 0 5px;"></div>
            <div class="input-group">
                <label for="dropRate">üìâ Îì±ÎùΩÌè≠(%):</label>
                <input type="number" id="dropRate" class="number-input" placeholder="2.5" step="0.1" oninput="updateChartSettings()">
            </div>
            <div class="input-group">
                <label for="basePrice">üö© Í∏∞Ï§ÄÍ∞Ä($):</label>
                <input type="number" id="basePrice" class="number-input" placeholder="ÏµúÍ≥†Í∞Ä" step="any" oninput="updateChartSettings()">
                <button class="nav-btn" style="background: #adb5bd; padding: 6px 10px; font-size: 12px; border-radius: 4px;" onclick="resetBasePrice()">ÏûêÎèô(Max)</button>
            </div>
        </div>

        <p style="font-size: 0.9em; color: #666; margin-top:-10px; margin-bottom: 20px;">
            * Í∞Å Ï¢ÖÎ™©Î≥ÑÎ°ú ÏÑ§Ï†ïÌïú <b>Í∏∞Ï§ÄÍ∞Ä</b>ÏôÄ <b>Îì±ÎùΩÌè≠</b>Ïù¥ ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.
        </p>

        <div class="symbol-list" id="symbolList"></div>
        <div id="statusMessage"></div>

        <div class="chart-container">
            <canvas id="mainChart"></canvas>
            <div id="chartjs-tooltip"></div>
        </div>
    </div>

    <script>
        let myChart = null;
        let symbols = []; 
        let currentSymbol = null;
        let currentData = null;
        const STORAGE_KEY = 'rebalancing_portfolio_v1';

        let configDropRate = 2.5;
        let configBasePrice = null;

        window.onload = function() {
            loadSymbols();
            if (symbols.length === 0) {
                symbols = [
                    { symbol: 'NVDA', basePrice: null, dropRate: 2.5 },
                    { symbol: 'TQQQ', basePrice: null, dropRate: 5.0 },
                    { symbol: 'SOXL', basePrice: null, dropRate: 10.0 }
                ];
                saveSymbols();
            }
            if (symbols.length > 0) {
                selectSymbol(symbols[0].symbol); 
            } else {
                renderTags();
            }
        };

        function loadSymbols() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (parsed.length > 0 && typeof parsed[0] === 'string') {
                        symbols = parsed.map(s => ({ symbol: s, basePrice: null, dropRate: 2.5 }));
                    } else {
                        symbols = parsed;
                    }
                } catch(e) { symbols = []; }
            }
        }

        function saveSymbols() { localStorage.setItem(STORAGE_KEY, JSON.stringify(symbols)); }
        function handleEnter(e) { if (e.key === 'Enter') addSymbol(); }

        function addSymbol() {
            const input = document.getElementById('symbolInput');
            const val = input.value.trim().toUpperCase();
            if (!val) return;
            if (symbols.some(s => s.symbol === val)) {
                showMessage('‚ö†Ô∏è Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ï¢ÖÎ™©ÏûÖÎãàÎã§.', 'orange');
                selectSymbol(val);
                input.value = '';
                return;
            }
            symbols.push({ symbol: val, basePrice: null, dropRate: 2.5 });
            saveSymbols();
            input.value = '';
            selectSymbol(val);
        }

        function removeSymbol(e, sym) {
            e.stopPropagation();
            symbols = symbols.filter(s => s.symbol !== sym);
            saveSymbols();
            if (currentSymbol === sym) {
                if (symbols.length > 0) selectSymbol(symbols[0].symbol);
                else {
                    currentSymbol = null;
                    destroyChart();
                    renderTags();
                    document.getElementById('dropRate').value = 2.5;
                    document.getElementById('basePrice').value = '';
                }
            } else {
                renderTags();
            }
        }

        function selectSymbol(sym) {
            currentSymbol = sym;
            const target = symbols.find(s => s.symbol === sym);
            if (target) {
                configDropRate = target.dropRate !== undefined ? target.dropRate : 2.5;
                configBasePrice = target.basePrice !== undefined ? target.basePrice : null;
                document.getElementById('dropRate').value = configDropRate;
                document.getElementById('basePrice').value = configBasePrice !== null ? configBasePrice : '';
            }
            renderTags();
            loadAndRenderChart(sym);
        }

        function renderTags() {
            const container = document.getElementById('symbolList');
            container.innerHTML = '';
            symbols.forEach(item => {
                const div = document.createElement('div');
                div.className = `tag ${item.symbol === currentSymbol ? 'active' : ''}`;
                div.onclick = () => selectSymbol(item.symbol);
                div.innerHTML = `${item.symbol} <span class="remove" onclick="removeSymbol(event, '${item.symbol}')">√ó</span>`;
                container.appendChild(div);
            });
        }

        function showMessage(msg, color='black') {
            const el = document.getElementById('statusMessage');
            el.style.color = color;
            el.innerText = msg;
        }

        function updateChartSettings() {
            const dropInput = document.getElementById('dropRate').value;
            const priceInput = document.getElementById('basePrice').value;
            configDropRate = parseFloat(dropInput);
            if (isNaN(configDropRate)) configDropRate = 2.5;
            configBasePrice = priceInput ? parseFloat(priceInput) : null;
            if (currentSymbol) {
                const target = symbols.find(s => s.symbol === currentSymbol);
                if (target) {
                    target.dropRate = configDropRate;
                    target.basePrice = configBasePrice;
                    saveSymbols();
                }
            }
            if (myChart) myChart.update();
        }

        function resetBasePrice() {
            document.getElementById('basePrice').value = '';
            updateChartSettings();
        }

        async function loadAndRenderChart(symbol) {
            showMessage(`‚è≥ ${symbol} Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...`, '#0d6efd');
            const dtEnd = Math.floor(Date.now() / 1000);
            const dtStart = dtEnd - (180 * 24 * 60 * 60);
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${dtStart}&period2=${dtEnd}&interval=1d`;
            const url = 'http://134.185.108.103:3000/proxy?url=' + encodeURIComponent(yahooUrl);

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Network Error');
                const json = await res.json();
                const result = json.chart.result[0];
                const timestamps = result.timestamp;
                const quotes = result.indicators.quote[0];
                const validLabels = [];
                const validPrices = [];
                timestamps.forEach((t, i) => {
                    if (quotes.close[i]) {
                        validLabels.push(new Date(t * 1000).toISOString().slice(0, 10));
                        validPrices.push(quotes.close[i]);
                    }
                });
                currentData = { labels: validLabels, prices: validPrices, symbol: symbol };
                drawChart();
                showMessage('‚úÖ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å', 'green');
                setTimeout(() => showMessage(''), 2000);
            } catch (e) {
                console.error(e);
                showMessage(`‚ùå ${symbol} Î°úÎìú Ïã§Ìå®`, 'red');
            }
        }

        const horizontalLinesPlugin = {
            id: 'horizontalLines',
            afterDatasetsDraw(chart, args, options) {
                const { ctx, chartArea: { top, bottom, left, right }, scales: { y }, width } = chart;
                
                if (!currentData || currentData.prices.length === 0) return;

                const maxPrice = Math.max(...currentData.prices);
                const base = configBasePrice !== null ? configBasePrice : maxPrice;
                const rate = configDropRate; 
                if (rate <= 0) return;

                const minVisiblePrice = y.min;
                const maxVisiblePrice = y.max;
                const lineEndX = width - 5;

                ctx.save();
                ctx.textAlign = 'right';
                ctx.textBaseline = 'bottom';
                ctx.font = '12px Arial';

                function drawLine(price, type) {
                    const yPos = y.getPixelForValue(price);
                    
                    if (yPos < top - 10 || yPos > bottom + 10) return;

                    ctx.beginPath();
                    ctx.lineWidth = 1;

                    if (type === 'base') {
                        ctx.strokeStyle = '#dc3545';
                        ctx.setLineDash([]);
                        ctx.fillStyle = '#dc3545';
                    } else if (type === 'up') {
                        ctx.strokeStyle = 'rgba(255, 99, 132, 0.6)';
                        ctx.setLineDash([4, 4]);
                        ctx.fillStyle = 'rgba(255, 99, 132, 0.9)';
                    } else { // down
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)';
                        ctx.setLineDash([4, 4]);
                        ctx.fillStyle = '#555';
                    }

                    ctx.moveTo(left, yPos);
                    ctx.lineTo(lineEndX, yPos);
                    ctx.stroke();

                    let labelText = '';
                    if (type === 'base') {
                        labelText = `Í∏∞Ï§Ä: $${price.toFixed(2)}`;
                    } else {
                        const diff = Math.abs((price - base) / base * 100);
                        const sign = type === 'up' ? '+' : '-';
                        labelText = `${sign}${diff.toFixed(1)}% ($${price.toFixed(2)})`;
                    }
                    
                    ctx.fillText(labelText, lineEndX - 5, yPos - 3);
                }

                drawLine(base, 'base');

                let count = 1;
                while (true) {
                    const price = base * (1 - (rate * count) / 100);
                    if (price < minVisiblePrice * 0.8) break; 
                    drawLine(price, 'down');
                    count++;
                    if (count > 100) break; 
                }

                count = 1;
                while (true) {
                    const price = base * (1 + (rate * count) / 100);
                    if (price > maxVisiblePrice * 1.2) break; 
                    drawLine(price, 'up');
                    count++;
                    if (count > 100) break; 
                }

                ctx.restore();
            }
        };

        function drawChart() {
            if (!currentData) return;
            const ctx = document.getElementById('mainChart').getContext('2d');
            const tooltipEl = document.getElementById('chartjs-tooltip');
            
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        label: currentData.symbol,
                        data: currentData.prices,
                        borderColor: '#0d6efd',
                        backgroundColor: '#0d6efd',
                        borderWidth: 2,
                        
                        // ‚òÖ Î∂àÎ¶ø ÏÑ§Ï†ï ‚òÖ
                        pointRadius: 3,                 
                        pointBackgroundColor: '#7693E1', 
                        pointBorderWidth: 0,            
                        
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#0d6efd',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2,

                        tension: 0.1,
                        fill: false
                    }]
                },
                plugins: [horizontalLinesPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            right: 70, 
                            top: 20,
                            bottom: 10
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipModel = context.tooltip;
                                if (tooltipModel.opacity === 0) {
                                    tooltipEl.style.opacity = 0;
                                    return;
                                }

                                if (tooltipModel.body) {
                                    const title = tooltipModel.title || [];
                                    const rawPrice = context.chart.data.datasets[0].data[tooltipModel.dataPoints[0].dataIndex];
                                    tooltipEl.innerHTML = `
                                        <div>${title[0]}</div>
                                        <div style="font-size:1.3em;">$${Number(rawPrice).toFixed(2)}</div>
                                    `;
                                }

                                const tooltipWidth = tooltipEl.offsetWidth;
                                
                                tooltipEl.style.opacity = 1;
                                
                                const leftPos = tooltipModel.caretX - (tooltipWidth / 2);
                                tooltipEl.style.left = leftPos + 'px';
                                
                                const topPos = tooltipModel.caretY + 45; 
                                tooltipEl.style.top = topPos + 'px';
                            }
                        }
                    },
                    scales: {
                        y: { grid: { display: false } },
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } }
                    }
                }
            });
        }
        
        function destroyChart() {
            if (myChart) myChart.destroy();
            myChart = null;
            currentData = null;
        }
    </script>
</body>
</html>